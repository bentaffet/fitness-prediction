<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Strava Fitness Analysis</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; max-width: 700px; margin: 40px auto; text-align: center; }
    button { background: #fc4c02; color: white; border: none; padding: 12px 24px; cursor: pointer; border-radius: 5px; margin: 10px 0; }
    button:hover { background: #e03d00; }
    canvas { margin-top: 30px; }
    pre { text-align: left; background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Strava Fitness Analysis</h1>
  <p>Connect Strava and see your modeled fitness.</p>

  <a id="strava-login" href="https://www.strava.com/oauth/authorize?client_id=185647&redirect_uri=https%3A%2F%2Ffitness-prediction.vercel.app%2F&approval_prompt=auto&scope=activity:read_all&response_type=code">
    <button>Connect with Strava</button>
  </a>

  <div id="status"></div>
  <button id="fetch-btn" style="display:none;">Fetch & Analyze Runs</button>
  <pre id="output"></pre>
  <canvas id="chart" width="700" height="400"></canvas>

  <script>
    const statusEl = document.getElementById("status");
    const outputEl = document.getElementById("output");
    const fetchBtn = document.getElementById("fetch-btn");
    const ctx = document.getElementById("chart").getContext("2d");
    let chart;

    let user_name = localStorage.getItem("user_name") || prompt("Enter your username:");
    localStorage.setItem("user_name", user_name);
    statusEl.textContent = "Username: " + user_name;
    fetchBtn.style.display = "inline-block";

    // Handle Strava OAuth code
    const code = new URLSearchParams(window.location.search).get("code");
    if (code) {
      fetch("/api/store-code", { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ code, user_name }) });
    }

    fetchBtn.addEventListener("click", async () => {
      outputEl.textContent = "Fetching runs...";
      try {
        const res = await fetch("/api/analyze", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ user_name })
        });
        const data = await res.json();
        outputEl.textContent = JSON.stringify(data, null, 2);

        const labels = data.runs.map((r,i)=>`Run ${i+1}`);
        const fitness = data.modeledfitness;

        if(chart) chart.destroy();
        chart = new Chart(ctx, {
          type:'line',
          data: { labels, datasets:[{ label:'Modeled Fitness', data:fitness, borderColor:'orange', backgroundColor:'rgba(252,76,2,0.2)', fill:true, tension:0.2 }]},
          options:{ responsive:true, scales:{ x:{ title:{display:true,text:'Run'} }, y:{ title:{display:true,text:'Fitness'} } } }
        });

      } catch(e) {
        outputEl.textContent = "Error: " + e.message;
      }
    });
  </script>
</body>
</html>
