<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Strava Fitness Analysis</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 40px auto;
      text-align: center;
    }
    button {
      background: #fc4c02;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 5px;
      margin: 10px 0;
    }
    button:hover { background: #e03d00; }
    input {
      padding: 8px;
      font-size: 14px;
      border-radius: 4px;
      border: 1px solid #ccc;
      margin: 10px 0;
    }
    pre {
      text-align: left;
      background: #f5f5f5;
      padding: 15px;
      border-radius: 5px;
      overflow-x: auto;
      margin-top: 20px;
    }
    canvas {
      margin-top: 30px;
      max-width: 100%;
    }
    #analysis-container {
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <h1>Strava Fitness/Fatigue Analysis</h1>

  <!-- Strava Login -->
  <div id="login-container">
    <a id="strava-login" href="https://www.strava.com/oauth/authorize?client_id=185647&redirect_uri=https%3A%2F%2Ffitness-prediction.vercel.app%2F&approval_prompt=auto&scope=activity%3Aread_all&response_type=code">
      <button>Connect with Strava</button>
    </a>
  </div>

  <div id="status"></div>

  <!-- Fetch button -->
  <div id="fetch-container" style="display:none;">
    <button id="fetch-runs-btn">Fetch & Analyze My Last Runs</button>
  </div>

  <!-- Analysis -->
  <div id="analysis-container"></div>

  <script type="module">
    import { analyzeActivities } from "./analyzeActivities.js";

    const statusEl = document.getElementById("status");
    const fetchContainer = document.getElementById("fetch-container");
    const analysisContainer = document.getElementById("analysis-container");
    let stravaRefresh = null;

    async function exchangeCodeForToken(code) {
      const res = await fetch(`/api/exchange?code=${code}`);
      return res.json();
    }

    async function fetchActivities(refreshToken) {
      const res = await fetch(`/api/activities?refresh_token=${refreshToken}`);
      return res.json();
    }

    function renderAnalysis(activities, analysis) {
      analysisContainer.innerHTML = "";

      // Total distance
      const totalMiles = (activities.reduce((sum, a) => sum + (a.distance || 0), 0) * 0.000621371).toFixed(2);
      const summary = document.createElement("p");
      summary.innerText = `Total Distance: ${totalMiles} miles`;
      analysisContainer.appendChild(summary);

      // Analysis JSON
      const pre = document.createElement("pre");
      pre.textContent = "Analysis:\n" + JSON.stringify(analysis, null, 2);
      analysisContainer.appendChild(pre);

      // Distance chart
      const canvas = document.createElement("canvas");
      analysisContainer.appendChild(canvas);
      new Chart(canvas, {
        type: "line",
        data: {
          labels: activities.map((a, i) => `Run ${i + 1}`),
          datasets: [{
            label: "Distance (miles)",
            data: activities.map(a => (a.distance * 0.000621371).toFixed(2)),
            borderColor: "#fc4c02",
            backgroundColor: "rgba(252,76,2,0.2)"
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            title: { display: true, text: "Run Distances" }
          }
        }
      });
    }

    async function main() {
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");

      if (code) {
        statusEl.innerText = "Authorizing with Strava…";
        try {
          const tokenData = await exchangeCodeForToken(code);
          if (tokenData.error) throw new Error(tokenData.error);

          stravaRefresh = tokenData.refresh_token;
          statusEl.innerText = "Authenticated! Click below to fetch your activities.";
          fetchContainer.style.display = "block";
        } catch (err) {
          statusEl.innerText = "Authorization failed.";
          console.error(err);
        }
      }

      document.getElementById("fetch-runs-btn").addEventListener("click", async () => {
        if (!stravaRefresh) {
          statusEl.innerText = "Missing Strava authentication!";
          return;
        }

        statusEl.innerText = "Fetching activities…";

        try {
          const data = await fetchActivities(stravaRefresh);
          if (data.error) throw new Error(data.error);

          const analysis = analyzeActivities(data.activities);
          renderAnalysis(data.activities, analysis);
          statusEl.innerText = "Analysis complete!";
        } catch (err) {
          statusEl.innerText = "Error fetching or analyzing runs.";
          console.error(err);
        }
      });
    }

    main();
  </script>
</body>
</html>
