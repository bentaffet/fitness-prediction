<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Strava Fitness Analysis</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial; max-width: 800px; margin: 40px auto; text-align: center; }
button { background: #fc4c02; color: white; border: none; padding: 12px 24px; font-size: 16px; cursor: pointer; border-radius: 5px; margin: 10px 0; }
button:hover { background: #e03d00; }
pre { text-align: left; background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; margin-top: 20px; }
canvas { margin-top: 30px; }
input { padding: 8px; font-size: 14px; border-radius: 4px; border: 1px solid #ccc; margin: 10px 0; }
</style>
</head>
<body>

<h1>Strava Fitness Analysis</h1>
<p>Authorize Strava and analyze your runs.</p>

<a id="strava-login" href="https://www.strava.com/oauth/authorize?client_id=185647&redirect_uri=https%3A%2F%2Ffitness-prediction.vercel.app%2F&approval_prompt=auto&scope=activity%3Aread_all&response_type=code">
  <button>Connect with Strava</button>
</a>

<div id="status"></div>

<div id="username-container">
  <input type="text" id="username-input" placeholder="Enter your username">
  <button id="set-username-btn">Set Username</button>
</div>

<button id="fetch-runs-btn" style="display:none;">Fetch & Analyze My Last Runs</button>
<pre id="runs-output"></pre>
<canvas id="fitness-chart" width="700" height="400"></canvas>

<script>
const statusEl = document.getElementById("status");
const outputEl = document.getElementById("runs-output");
const fetchBtn = document.getElementById("fetch-runs-btn");
const ctx = document.getElementById("fitness-chart").getContext("2d");
let fitnessChart;

let user_name = localStorage.getItem("user_name") || "";

const usernameInput = document.getElementById("username-input");
const setUsernameBtn = document.getElementById("set-username-btn");

// Show/hide based on saved username
if(user_name){
  usernameInput.style.display = "none";
  setUsernameBtn.style.display = "none";
  fetchBtn.style.display = "inline-block";
  statusEl.textContent = `Username: ${user_name}`;
}

setUsernameBtn.addEventListener("click", ()=>{
  const val = usernameInput.value.trim();
  if(!val) return alert("Enter username");
  user_name = val;
  localStorage.setItem("user_name", user_name);
  usernameInput.style.display = "none";
  setUsernameBtn.style.display = "none";
  fetchBtn.style.display = "inline-block";
  statusEl.textContent = `Username: ${user_name}`;
});

// Handle Strava OAuth code
const params = new URLSearchParams(window.location.search);
const code = params.get("code");
if(code) sendCodeToBackend(code);

async function sendCodeToBackend(code){
  if(!user_name) return alert("Set username first");
  statusEl.textContent = "Sending code to backend...";
  try{
    const res = await fetch("/api/store-code", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({code, user_name})
    });
    const data = await res.json();
    if(res.ok){
      statusEl.textContent = "✅ Code stored!";
      fetchBtn.style.display="inline-block";
    } else {
      statusEl.textContent = "❌ Failed to store code";
      outputEl.textContent = JSON.stringify(data,null,2);
    }
  } catch(err){
    statusEl.textContent = "❌ Error sending code";
    outputEl.textContent = err.message;
  }
}

fetchBtn.addEventListener("click", ()=> fetchRuns());

async function fetchRuns(max_runs=20){
  if(!user_name) return alert("Set username first");
  outputEl.textContent = "Fetching runs...";
  try{
    const res = await fetch("/api/fetch-runs", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({user_name, max_runs})
    });
    const data = await res.json();
    let runs = data.activities || [];
    if(!runs.length){
      outputEl.textContent="⚠️ No runs found";
      return;
    }
    outputEl.textContent = JSON.stringify(runs,null,2);
    analyzeRuns(runs);
  } catch(err){
    outputEl.textContent = "❌ Error fetching runs: "+err.message;
  }
}

function analyzeRuns(runs){
  statusEl.textContent = "Analyzing runs...";
  const modeledfitness = runs.map(r=>{
    const distance_mi = r.distance_m*0.000621371;
    const pace = r.moving_time_s/60/distance_mi;
    const hr = r.average_heartrate || 100;
    return distance_mi / pace * (hr/100);
  });

  const labels = runs.map((r,i)=>`Run ${i+1}`);
  if(fitnessChart) fitnessChart.destroy();
  fitnessChart = new Chart(ctx,{
    type:'line',
    data:{
      labels,
      datasets:[{
        label:'Modeled Fitness',
        data:modeledfitness,
        borderColor:'rgba(252,76,2,1)',
        backgroundColor:'rgba(252,76,2,0.2)',
        fill:true,
        tension:0.2
      }]
    },
    options:{
      responsive:true,
      scales:{
        x:{ title:{ display:true, text:'Run'} },
        y:{ title:{ display:true, text:'Modeled Fitness'} }
      }
    }
  });
  statusEl.textContent = "✅ Analysis complete!";
}
</script>
</body>
</html>
