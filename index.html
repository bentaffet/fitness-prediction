<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Strava Fitness Analysis</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; max-width: 800px; margin: 40px auto; text-align: center; }
    button { background: #fc4c02; color: white; border: none; padding: 12px 24px; font-size: 16px; cursor: pointer; border-radius: 5px; margin: 10px 0; }
    button:hover { background: #e03d00; }
    input { padding: 8px; font-size: 14px; border-radius: 4px; border: 1px solid #ccc; margin: 10px 0; }
    pre { text-align: left; background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; margin-top: 20px; }
    canvas { margin-top: 30px; }
  </style>
</head>
<body>
  <h1>Strava Fitness/Fatigue Analysis</h1>
  <p>Authorize Strava and analyze your runs.</p>

  <!-- Strava login -->
  <a id="strava-login" href="https://www.strava.com/oauth/authorize?client_id=185647&redirect_uri=https%3A%2F%2Ffitness-prediction.vercel.app%2F&approval_prompt=auto&scope=activity%3Aread_all&response_type=code">
    <button>Connect with Strava</button>
  </a>

  <!-- Username input -->
  <div id="username-container">
    <input type="text" id="username-input" placeholder="Enter your username">
    <button id="set-username">Set Username</button>
  </div>

  <div id="status"></div>
  <button id="fetch-runs-btn" style="display:none;">Fetch & Analyze My Last Runs</button>


<<script type="module">
import { analyzeActivities } from "./analyzeActivities.js";

async function main() {
  const status = document.getElementById("status");
  const fetchBtn = document.getElementById("fetch-runs-btn");

  // Check if Strava redirected back with ?code=xxxx
  const params = new URLSearchParams(window.location.search);
  const code = params.get("code");

  // ---------------------------------------------------
  // AUTHENTICATION FLOW (kept intact)
  // ---------------------------------------------------
  if (code) {
    status.innerText = "Authorizing with Strava…";

    const tokenRes = await fetch(`/api/exchange?code=${code}`);
    const tokenData = await tokenRes.json();

    if (tokenData.error) {
      status.innerText = "Authorization failed.";
      console.error(tokenData);
      return;
    }

    // Store refresh token in memory
    window.STRAVA_REFRESH = tokenData.refresh_token;

    status.innerText = "Authenticated! Click the button to fetch your activities.";
    fetchBtn.style.display = "block";
  }

  // ---------------------------------------------------
  // FETCH ACTIVITIES + PRINT + ANALYZE
  // ---------------------------------------------------
  fetchBtn.addEventListener("click", async () => {
    if (!window.STRAVA_REFRESH) {
      status.innerText = "Missing Strava authentication!";
      return;
    }

    status.innerText = "Fetching activities…";

    const res = await fetch(`/api/activities?refresh_token=${window.STRAVA_REFRESH}`);
    const data = await res.json();

    if (data.error) {
      status.innerText = "Error fetching runs.";
      console.error(data);
      return;
    }

    // Total distance (meters → miles)
    const miles = (data.total_distance * 0.000621371).toFixed(2);
    status.innerText = `Total Distance: ${miles} miles`;

    // Print activities to page
    const raw = document.createElement("pre");
    raw.textContent = JSON.stringify(data.activities, null, 2);
    document.body.appendChild(raw);

    // Analyze
    const analysis = analyzeActivities(data.activities);

    const analysisBox = document.createElement("pre");
    analysisBox.textContent = "Analysis:\n" + JSON.stringify(analysis, null, 2);
    document.body.appendChild(analysisBox);

    console.log("Activities:", data.activities);
    console.log("Analysis:", analysis);
  });
}

main();
</script>


</body>
</html>
